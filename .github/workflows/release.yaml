name: Release

on:
  release:
    types: [released]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.set-matrix.outputs.projects }}
      os: ${{ steps.set-matrix.outputs.os }}
    steps:
      - id: set-matrix
        run: |
          echo "projects=[\"Importer\",\"AllureExporter\",\"AzureExporter\",\"ZephyrScaleExporter\",\"ZephyrScaleServerExporter\",\"ZephyrSquadExporter\",\"ZephyrSquadServerExporter\",\"XRayExporter\",\"TestCollabExporter\",\"TestLinkExporter\",\"TestRailExporter\",\"TestRailXmlExporter\",\"PractiTestExporter\",\"SpiraTestExporter\",\"HPALMExporter\",\"QaseExporter\"]" >> $GITHUB_OUTPUT
          echo "os=[\"win-x64\",\"linux-x64\",\"osx-x64\"]" >> $GITHUB_OUTPUT

  build:
    needs: prepare
    strategy:
      fail-fast: true
      matrix:
        project: ${{fromJson(needs.prepare.outputs.projects)}}
        os: ${{fromJson(needs.prepare.outputs.os)}}
    uses: ./.github/workflows/build-project.yml
    with:
      project_path: ./Migrators/${{ matrix.project }}
      runtime: ${{ matrix.os }}

  upload:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{fromJson(needs.prepare.outputs.projects)}}
        os: ${{fromJson(needs.prepare.outputs.os)}}
    steps:
      - name: Set artifact names
        id: artifacts
        run: |
          if [ "${{ matrix.os }}" = "win-x64" ]; then
            echo "artifact_name=${{ matrix.project }}.exe" >> $GITHUB_OUTPUT
            echo "asset_name=${{ matrix.project }}-${{ matrix.os }}-${{ github.event.release.tag_name }}.exe" >> $GITHUB_OUTPUT
          else
            echo "artifact_name=${{ matrix.project }}" >> $GITHUB_OUTPUT
            echo "asset_name=${{ matrix.project }}-${{ matrix.os }}-${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: publish/${{ steps.artifacts.outputs.artifact_name }}
          asset_name: ${{ steps.artifacts.outputs.asset_name }}
          tag: ${{ github.ref }}
          overwrite: true
